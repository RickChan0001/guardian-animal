{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="form-card">
  <h2>Cadastrar Animal</h2>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="photo-upload-container">
      <img id="preview" src="{% static 'images/default-pet.jpg' %}" alt="preview" class="photo-preview">
      <label class="upload-btn" for="id_foto">
        Escolher Foto
      </label>
      {{ form.foto }}
      {% if form.foto.errors %}
        <div class="error-msg" style="color: red; margin-top: 5px;">{{ form.foto.errors }}</div>
      {% endif %}
    </div>

    <div class="form-row">
      <div class="fields-col">

        {% if form.errors %}
          <div class="error-messages" style="color: red; margin-bottom: 15px;">
            <strong>Erros no formulário:</strong>
            {{ form.errors }}
          </div>
        {% endif %}

        <label>Nome</label>
        {{ form.nome }}
        {% if form.nome.errors %}
          <div class="error-msg">{{ form.nome.errors }}</div>
        {% endif %}

        <label>Espécie</label>
        {{ form.especie }}

        <label>Raça</label>
        {{ form.raca }}

        <label>Idade (anos)</label>
        {{ form.idade }}

        <label>Altura (cm)</label>
        {{ form.altura }}

        <label>Peso (kg)</label>
        {{ form.peso }}

        <label>Observações</label>
        {{ form.observacoes }}

        <button class="btn-primary" type="submit" style="margin-top: 15px;">Salvar Animal</button>

        <a href="{% url 'tutores:painel_tutor' %}" 
           class="btn-primary" 
           style="margin-top: 15px; background-color: #6c757d;">
          ← Voltar ao Painel
        </a>
      </div>
    </div>
  </form>
</div>

<script>
// Preview da foto
const inputFoto = document.getElementById('id_foto') || document.querySelector('input[name="foto"]');
const preview = document.getElementById('preview');
if (inputFoto) {
  // Esconde o input padrão do Django e estiliza
  inputFoto.style.display = 'none';
  
  inputFoto.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      preview.src = ev.target.result;
    }
    reader.readAsDataURL(file);
  });
}

// Atualização dinâmica de raças baseado na espécie
const racasPorEspecie = {
  'cachorro': [
    { value: '', text: 'Selecione a raça' },
    { value: 'labrador', text: 'Labrador' },
    { value: 'poodle', text: 'Poodle' },
    { value: 'bulldog', text: 'Bulldog' },
    { value: 'vira_lata', text: 'Vira-lata' },
    { value: 'outro', text: 'Outro' }
  ],
  'gato': [
    { value: '', text: 'Selecione a raça' },
    { value: 'persa', text: 'Persa' },
    { value: 'siames', text: 'Siames' },
    { value: 'maine_coon', text: 'Maine coon' },
    { value: 'vira_lata', text: 'Vira-lata' },
    { value: 'outro', text: 'Outro' }
  ],
  'passaro': [
    { value: '', text: 'Selecione a raça' },
    { value: 'canario', text: 'Canario' },
    { value: 'calopsita', text: 'Calopsita' },
    { value: 'periquito', text: 'Periquito' },
    { value: 'outro', text: 'Outro' }
  ],
  'outro': [
    { value: '', text: 'Selecione a raça' },
    { value: 'outro', text: 'Outro' }
  ]
};

// Encontra os campos de espécie e raça (tenta por ID primeiro, depois por name)
const especieSelect = document.getElementById('id_especie') || document.querySelector('select[name="especie"]');
const racaSelect = document.getElementById('id_raca') || document.querySelector('select[name="raca"]');

if (especieSelect && racaSelect) {
  // Função para atualizar as opções de raça
  function atualizarRacas() {
    const especieSelecionada = especieSelect.value;
    
    // Limpa as opções atuais
    racaSelect.innerHTML = '';
    
    // Obtém as raças para a espécie selecionada
    const racas = racasPorEspecie[especieSelecionada] || racasPorEspecie['outro'];
    
    // Adiciona as novas opções
    racas.forEach(raca => {
      const option = document.createElement('option');
      option.value = raca.value;
      option.textContent = raca.text;
      racaSelect.appendChild(option);
    });
  }
  
  // Atualiza quando a espécie muda
  especieSelect.addEventListener('change', atualizarRacas);
  
  // Atualiza na carga inicial se já houver uma espécie selecionada
  if (especieSelect.value) {
    atualizarRacas();
  }
}
</script>
{% endblock %}
